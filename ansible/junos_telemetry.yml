---
- name: Collect Junos Telemetry and Export to Prometheus
  hosts: junos_devices
  connection: local
  gather_facts: no
  
  vars:
    netconf_port: 830
    # Use /output for container, ../output for host
    output_dir: "{{ '/output' if playbook_dir == '/ansible' else '../output' }}"
    prometheus_pushgateway: "http://pushgateway:9091"
    rpc_config_file: "rpc_commands.yml"
    # Optional: Comma-separated list of interfaces to monitor (e.g., "et-0/0/32,et-0/0/33")
    # If not set or empty, all interfaces will be monitored
    interface_filter: ""
  
  tasks:
    - name: Ensure output directory exists
      local_action:
        module: file
        path: "{{ output_dir }}"
        state: directory
        mode: '0777'
      run_once: true
      changed_when: false
    
    - name: Clean output directory before run
      local_action:
        module: shell
        cmd: "find {{ output_dir }} -type f -delete 2>/dev/null || true"
      run_once: true
      changed_when: false
    
    - name: Load RPC commands configuration
      include_vars:
        file: "{{ rpc_config_file }}"
        name: rpc_config
    
    - name: Execute RPC commands on Junos device
      junipernetworks.junos.junos_rpc:
        rpc: "{{ item.rpc }}"
        output: xml
        # host: "{{ inventory_hostname }}"
        # port: "{{ netconf_port }}"
        # username: "{{ ansible_user }}"
        # password: "{{ ansible_password }}"
      register: rpc_results
      loop: "{{ rpc_config.rpc_commands }}"
      loop_control:
        label: "{{ item.name }}"
    
    - name: Debug RPC output structure
      debug:
        msg: 
          - "Output type: {{ item.output | type_debug }}"
          - "Output length: {{ item.output | length if item.output is sequence else 'N/A' }}"
          - "Has output_lines: {{ 'output_lines' in item }}"
      loop: "{{ rpc_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: false  # Set to true to enable debugging
    
    - name: Save raw RPC outputs
      copy:
        content: "{{ item.output | join('') if item.output is sequence else item.output }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}_{{ item.item.name }}_raw.xml"
      loop: "{{ rpc_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"
    
    - name: Determine interface filter for this device
      set_fact:
        device_interface_filter: "{{ hostvars[inventory_hostname].interface_filter | default(interface_filter) }}"
    
    - name: Parse RPC outputs and convert to JSON format
      script: >
        parsers/{{ item.item.parser }}.py
        --input "{{ output_dir }}/{{ inventory_hostname }}_{{ item.item.name }}_raw.xml"
        --output "{{ output_dir }}/{{ inventory_hostname }}_{{ item.item.name }}_metrics.json"
        --device "{{ inventory_hostname }}"
        --format json
        {% if device_interface_filter %}--interfaces "{{ device_interface_filter }}"{% endif %}
      args:
        executable: python3
      loop: "{{ rpc_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      register: parse_results
    
    - name: Display parsing results
      debug:
        msg: "Parsed {{ item.item.item.name }}: {{ item.stdout_lines }}"
      loop: "{{ parse_results.results }}"
      loop_control:
        label: "{{ item.item.item.name }}"
      when: item.stdout_lines is defined
    
    - name: Push metrics to Prometheus Pushgateway
      script: >
        scripts/push_to_prometheus.py
        --pushgateway "{{ prometheus_pushgateway }}"
        --job "junos_telemetry"
        --instance "{{ inventory_hostname }}"
        --metrics-file "{{ output_dir }}/{{ inventory_hostname }}_{{ item.item.name }}_metrics.json"
        --format json
      args:
        executable: python3
      loop: "{{ rpc_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: prometheus_pushgateway is defined
